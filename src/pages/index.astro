---
import Layout from "../layouts/Layout.astro";
import sand from "../assets/sand.jpg";

// Color theme configuration
const COLORS = {
    navy: "#001f3f",
    orange: "#C85A1F",
    skyblue: "#4A8BA8",
    camelia: "#A84F7A",
    olive: "#3D4F23",
};

const DEFAULT_COLOR = COLORS.navy;
const TRANSITION_DURATION = 900; // milliseconds
---

<Layout>
    <div
        class="absolute top-0 left-0 w-full h-full opacity-8 pointer-events-none z-1000"
        style={{
            backgroundImage: `url(${sand.src})`,
            backgroundRepeat: "repeat",
            backgroundSize: "500px 500px",
        }}
        aria-hidden="true"
    >
    </div>
    <div
        id="main-container"
        class="min-h-screen text-white overflow-hidden"
        style={`background-color: ${DEFAULT_COLOR}`}
        data-current-color="navy"
    >
        <!-- Transition layer -->
        <div
            id="transition-layer"
            class="absolute inset-0 pointer-events-none opacity-0"
            style="clip-path: circle(0% at 50% 50%);"
        >
        </div>
        <nav class="p-6 relative z-10" aria-label="Color theme selector">
            <ul
                class="flex flex-row flex-wrap gap-6 font-semibold text-xl justify-center sm:justify-start"
            >
                {
                    Object.keys(COLORS).map((colorKey) => (
                        <li>
                            <button
                                class="cursor-pointer capitalize hover:opacity-80 transition-all focus-visible:outline-none focus-visible:drop-shadow-[0_0_8px_rgba(255,255,255,0.8)] px-2 py-1"
                                data-color={colorKey}
                                aria-pressed={
                                    colorKey === "navy" ? "true" : "false"
                                }
                                aria-label={`Change theme to ${colorKey}`}
                            >
                                {colorKey}
                            </button>
                        </li>
                    ))
                }
            </ul>
        </nav>
    </div>
</Layout>

<script define:vars={{ COLORS, TRANSITION_DURATION }}>
    // DOM elements
    const container = document.getElementById("main-container");
    const transitionLayer = document.getElementById("transition-layer");
    const colorButtons = document.querySelectorAll("[data-color]");

    // Animation state
    let isAnimating = false;

    /**
     * Circle expand transition effect
     * Expands a circular mask from center to reveal new color
     */
    const circleExpandTransition = (newColor) => {
        if (!container || !transitionLayer) return;

        // Prepare transition layer
        transitionLayer.style.backgroundColor = newColor;
        transitionLayer.style.clipPath = "circle(0% at 50% 50%)";
        transitionLayer.style.opacity = "1";

        // Trigger transition on next frame
        requestAnimationFrame(() => {
            transitionLayer.style.transition = `clip-path ${TRANSITION_DURATION}ms cubic-bezier(0.4, 0, 0.2, 1)`;
            transitionLayer.style.clipPath = "circle(150% at 50% 50%)";
        });

        // Complete transition
        setTimeout(() => {
            container.style.backgroundColor = newColor;
            transitionLayer.style.transition = "none";
            transitionLayer.style.opacity = "0";
            transitionLayer.style.clipPath = "circle(0% at 50% 50%)";
            isAnimating = false;
        }, TRANSITION_DURATION);
    };

    /**
     * Update ARIA pressed states
     * for a11y only
     */
    const updateActiveStates = (activeColorKey) => {
        colorButtons.forEach((button) => {
            const buttonColorKey = button.getAttribute("data-color");
            const isActive = buttonColorKey === activeColorKey;

            // Update ARIA state
            button.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
    };

    /**
     * Handles color change with validation
     */
    const changeColor = (colorKey) => {
        if (!container) return;

        // Get current color
        const currentColor = container.getAttribute("data-current-color");

        // Skip if same color or animating
        if (currentColor === colorKey || isAnimating) return;

        const newColor = COLORS[colorKey];
        if (!newColor) return;

        // Update state
        isAnimating = true;
        container.setAttribute("data-current-color", colorKey);

        // Update ARIA states
        updateActiveStates(colorKey);

        // Execute transition
        circleExpandTransition(newColor);
    };

    /**
     * Initialize color switcher event listeners
     */
    const init = () => {
        colorButtons.forEach((button) => {
            // Click handler
            button.addEventListener("click", () => {
                const colorKey = button.getAttribute("data-color");
                if (colorKey) {
                    changeColor(colorKey);
                }
            });
        });
    };

    // Start application
    init();
</script>
